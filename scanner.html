<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>RFID Scan</title>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap');

    body {
        margin: 0;
        font-family: 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #4b0082, #8a2be2);
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #fff;
    }

    .scan-container {
        background: rgba(255, 255, 255, 0.07);
        border: 1px solid rgba(255, 255, 255, 0.18);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 30px 40px;
        width: 360px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35);
        text-align: center;
    }

    h2 {
        margin-bottom: 25px;
        font-size: 22px;
        font-weight: 600;
    }

    #rfidInput,
    #remarksInput {
        width: 320px;
        padding: 12px 15px;
        border: none;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.12);
        color: white;
        font-size: 15px;
        outline: none;
        transition: 0.3s;
        margin-top: 15px;
    }

    #rfidInput::placeholder,
    #remarksInput::placeholder {
        color: #ccc;
    }

    #rfidInput:focus,
    #remarksInput:focus {
        background: rgba(75, 0, 130, 0.6);
        box-shadow: 0 0 8px #a64dfc;
    }

    #actionSelect {
        width: 350px;
        padding: 12px 15px;
        border: none;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.12);
        color: white;
        font-size: 15px;
        outline: none;
        transition: 0.3s;
        margin-top: 15px;
    }

    #actionSelect:focus {
        background: rgba(75, 0, 130, 0.6);
        box-shadow: 0 0 8px #a64dfc;
    }

    option {
        color: black;
    }

    #submitBtn {
        margin-top: 25px;
        width: 350px;
        padding: 12px 15px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(to right, #a64dfc, #5d0cff);
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
    }

    #submitBtn:hover {
        background: linear-gradient(to right, #5d0cff, #a64dfc);
    }

    .popup {
        display: none;
        position: fixed;
        z-index: 999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
    }

    .popup-content {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.3);
        color: #fff;
        padding: 30px;
        width: 360px;
        max-width: 90%;
        margin: 15% auto;
        text-align: center;
        backdrop-filter: blur(15px);
        box-shadow: 0 8px 32px rgba(0,0,0,0.35);
        animation: fadeIn 0.3s ease;
        position: relative;
    }

    .popup-content h3 {
        margin-top: 0;
        font-size: 20px;
        margin-bottom: 15px;
    }

    .popup-content p {
        font-size: 16px;
        white-space: pre-line;
    }

    .close {
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 24px;
        cursor: pointer;
    }

    @keyframes fadeIn {
        from {opacity: 0; transform: translateY(-20px);}
        to {opacity: 1; transform: translateY(0);}
    }
    </style>
</head>
<body>
    <div class="scan-container">
        <h2>Scan RFID</h2>
        <input
            type="text"
            id="rfidInput"
            placeholder="Scan RFID tag here (numbers only)"
            autofocus
            autocomplete="off"
            inputmode="numeric"
            pattern="[0-9]*"
            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
        />
        <select id="actionSelect">
            <option value="login">Login</option>
            <option value="logout">Logout</option>
        </select>
        <input
            type="text"
            id="remarksInput"
            placeholder="Event"
            autocomplete="off"
        />
        <button id="submitBtn" type="button">Submit</button>
    </div>

    <div id="popup" class="popup">
        <div class="popup-content">
            <span id="closePopup" class="close">&times;</span>
            <h3 id="popupTitle">Title</h3>
            <p id="popupMessage">Message goes here</p>
        </div>
    </div>

    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCJ4mFth7Z4vBYfSBvDD5c1jLjTkpqQWVQ",
  authDomain: "rfid-register-47201.firebaseapp.com",
  projectId: "rfid-register-47201",
  storageBucket: "rfid-register-47201.appspot.com",
  messagingSenderId: "436530146046",
  appId: "1:436530146046:web:e16fe037b82d1195c553af",
  measurementId: "G-X5ZJFYJQBW"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const rfidInput = document.getElementById('rfidInput');
const remarksInput = document.getElementById('remarksInput');
const actionSelect = document.getElementById('actionSelect');
const submitBtn = document.getElementById('submitBtn');

window.onload = () => {
    rfidInput.focus();
};

// Custom popup
function showPopup(title, message) {
    const popup = document.getElementById('popup');
    const popupTitle = document.getElementById('popupTitle');
    const popupMessage = document.getElementById('popupMessage');
    const closeBtn = document.getElementById('closePopup');

    popupTitle.textContent = title;
    popupMessage.textContent = message;
    popup.style.display = 'block';

    closeBtn.onclick = () => {
        popup.style.display = 'none';
        rfidInput.focus();
    };
}

window.addEventListener('click', (event) => {
    const popup = document.getElementById('popup');
    if (event.target == popup) {
        popup.style.display = 'none';
        rfidInput.focus();
    }
});

// Close popup with Escape key
window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const popup = document.getElementById('popup');
        if (popup.style.display === 'block') {
            popup.style.display = 'none';
            rfidInput.focus();
        }
    }
});

// Enter key navigation
function handleEnterFocus(e, nextElement) {
    if (e.key === "Enter") {
        e.preventDefault();
        if (e.target.value.trim() === "") {
            showPopup("⚠ Warning", "This field cannot be empty!");
            e.target.style.border = "2px solid red";
        } else {
            e.target.style.border = ""; 
            nextElement.focus();
        }
    }
}

rfidInput.addEventListener("keydown", (e) => handleEnterFocus(e, actionSelect));
actionSelect.addEventListener("keydown", (e) => handleEnterFocus(e, remarksInput));
remarksInput.addEventListener("keydown", (e) => handleEnterFocus(e, submitBtn));

// Submission
async function handleSubmit() {
    let rfidRaw = rfidInput.value.trim();
    if (!rfidRaw) {
        showPopup('⚠ Warning', 'Please scan or enter RFID tag.');
        return;
    }

    const rfidString = rfidRaw;
    const rfidNumber = Number(rfidRaw);

    try {
        const studentsRef = collection(db, "students");

        // Query Firestore for both string and number
        const queryString = query(studentsRef, where("rfid_code", "==", rfidString));
        const queryNumber = isNaN(rfidNumber) ? null : query(studentsRef, where("rfid_code", "==", rfidNumber));

        const resultsString = await getDocs(queryString);
        let resultsNumber = { empty: true, docs: [] };
        if (queryNumber) {
            resultsNumber = await getDocs(queryNumber);
        }

        const allResults = [...resultsString.docs, ...resultsNumber.docs];

        console.log("Firestore query results:", allResults.map(doc => doc.data()));

        if (allResults.length === 0) {
            showPopup('⚠ Not Registered', 'This RFID is not registered in the system!');
            rfidInput.value = '';
            return;
        }

        let ownerInfo = allResults.map(doc => {
            const data = doc.data();
            return `${data.last_name}, ${data.given_name}`;
        }).join(", ");

        const data = {
            rfid_code: rfidRaw,
            action: actionSelect.value,
            remarks: remarksInput.value.trim() || "No remarks",
            timestamp: serverTimestamp(),
            owner: ownerInfo
        };

        await addDoc(collection(db, "rfid_logs"), data);

        showPopup('✅ Success', `RFID recorded successfully!\nRFID: ${rfidRaw}\nOwner: ${ownerInfo}\nAction: ${actionSelect.value}\nRemarks: ${remarksInput.value.trim() || "No remarks"}`);

        rfidInput.value = '';
        remarksInput.value = '';
        rfidInput.focus();
    } catch (error) {
        console.error("Error saving to Firestore:", error);
        showPopup('⚠ Error', "Error saving to Firebase: " + error.message);
    }
}

submitBtn.addEventListener('click', handleSubmit);
    </script>
</body>
</html>
